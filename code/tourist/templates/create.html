{% extends 'base.html' %}
{% block title %}建立行程{% endblock %}
{% block content %}
  <link rel="stylesheet" href="/static/css/create.css">
  <script></script>
{% endblock %}
{% block body %}
<main>
  <div class="container tab_div">
    <div class="tabtitle">
      <ul class="nav nav-tabs flex justify-content-center mt-5 my-nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="create-nav-link tab_a active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button"
        role="tab" aria-controls="home" aria-selected="true" onclick="saveTabState('home')">建立行程</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="create-nav-link tab_a" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button"
          role="tab" aria-controls="contact" aria-selected="false" onclick="saveTabState('contact')">我的收藏</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="create-nav-link tab_a" id="recommend-tab" data-bs-toggle="tab" data-bs-target="#recommend" type="button"
          role="tab" aria-controls="recommend" aria-selected="false" onclick="saveTabState('recommend')">推薦景點</button>
        </li>
      </ul>
    </div>
  </div>
  <!-- 建立行程 -->
  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
      <div>
        <form action="" class="createdataform">
          <div class="row createdata" style="width: 80%;">
            <div class="col-md-6 tabc_txt">
              行程名稱：{{ name }}
              {% comment %} <input type="text" class="input_txt" ng-model="travName"  style="width: 180px" value="{{ name }}"> {% endcomment %}
            </div>
            <div class="col-md-6 tabc_txt">
              出發日期：{{ start_day }}
              {% comment %} <input type="date" class="input_txt" value="{{ start_day }}"> {% endcomment %}
            </div>
            {% comment %} 
            <div class="col-md-4 tabc_txt">
              結束日期：
              <input type="date" class="input_txt" value="2023-05-26">
            </div> 
            {% endcomment %}
          </div>
        </form>
      </div>
      <div class="row">
        <div style="display: flex;justify-content: center;align-items: center;align-content: center;">
          <ul class="nav nav-underline">
            <li class="nav-item">
              <a class="create-nav-link createday active" aria-current="page" href="#">第一天</a>
            </li>
            <li class="nav-item">
              <a class="create-nav-link createday" href="#">第二天</a>
            </li>
            <li class="nav-item">
              <a class="create-nav-link createday" href="#">第三天</a>
            </li>
          </ul>
        </div>
        <div class="row" style="margin-top: 10px;">
          <div class="col-md-4 div_day" style="background-color: #fffdc8;">
            <div class="row">
              <div class="div_day " style="text-align: center;">
                <div class="tabD">
                  <span ng-bind="travName"></span>
                </div>
                {% comment %} <button id="addDay">+一天</button> {% endcomment %}
                {% comment %} <button class="tab_day">第{{ day }}天</button> {% endcomment %}
                <div class="tabD" id="addDaydiv">
                  {% for day in travelday %}
                    <span class="tab_day" onclick="clickDay({{day}})">第{{ day }}天</span>
                    <p></p>
                  {% endfor %}
                </div>
                <div class=" tabc_txt">
                  <span class="save" id="saveDays">儲存</span>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8" style="background-color: #eee;">
            <form action="#tab_c" style="color: black;">
              <div>
                <div class="tabD">
                  <span id="tabDT">請輸入出發時間：</span>
                  <input type="time" name="nowtime" id="nowtime" value="09:00">
                </div>
                <div class="tabD">
                  <span id="tabDL">使用者位置：</span>
                  <input type="text" placeholder="請輸入位置" class="input_txt" id="userLocation">
                  <input type="hidden" placeholder="day" class="nowday" id="nowday">
                </div>
              </div>
            </form>
            <div id="OrderAttractions">
              {% for attractions in ct_attractions_list %}
              
              {% endfor %}
              <!-- <span class="create_txt" >第</span>
                <button style="border: none;">+</button> -->
              <!--我在JS~~~~~~~~~~~
                <div class="spot" id="spot1">
                  國父紀念館
                  <p>位在台北市XX區</p>
                  <p>
                    目前人潮流量：適中
                    <br>
                    營業時間：09:00-18:00
                    <br>
                    建議停留時間：1小時
                  </p>
                </div>
              -->
            </div>
            <div id="RemainderAttractions"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 我的收藏 -->
    <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
      <div class="row favoritedata">
        <div class="col-lg-4 col-md-6">
          <div style="text-align: center;">
            <div class="heart_icon_box">
              <img src="/static/images/pingxi.jpg" class="img-responsive" width="100%">
              <i class="fa-solid fa-heart heart_icon"></i>
            </div>
            <div class="spot_like_txt">
              <h3 class="spot_title">平溪老街</h3>
              <p>123456</p>
              <div class="group">
                <i class="fa-solid fa-plus add_icon"></i>
                <div class="dropdown_menu">
                  <div>
                    <a class="dropdown_item" href="#tab_c">新增行程</a>
                  </div>
                  <div>
                    <a class="dropdown_item" href="#">捷運一日遊</a>
                  </div>
                  <div>
                    <a class="dropdown_item" href="#">開車一日遊</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4 col-md-6">
          <div style="text-align: center;">
            <div class="heart_icon_box">
              <img src="/static/images/pingxi.jpg" class="img-responsive" width="100%">
              <i class="fa-solid fa-heart heart_icon"></i>
            </div>
            <div class="spot_like_txt">
              <h3 class="spot_title">平溪老街</h3>
              <p>123456</p>
              <div class="group">
                <i class="fa-solid fa-plus add_icon"></i>
                <div class="dropdown_menu">
                  <div>
                    <a class="dropdown_item" href="#tab_c">新增行程</a>
                  </div>
                  <div>
                    <a class="dropdown_item" href="#">捷運一日遊</a>
                  </div>
                  <div>
                    <a class="dropdown_item" href="#">開車一日遊</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4 col-md-6">
          <div style="text-align: center;">
            <div class="heart_icon_box">
              <img src="/static/images/pingxi.jpg" class="img-responsive" width="100%">
              <i class="fa-solid fa-heart heart_icon"></i>
            </div>
            <div class="spot_like_txt">
              <h3 class="spot_title">平溪老街</h3>
              <p>123456</p>
              <div class="group">
                <i class="fa-solid fa-plus add_icon"></i>
                <div class="dropdown_menu">
                  <div>
                    <a class="dropdown_item" href="#tab_c">新增行程</a>
                  </div>
                  <div>
                    <a class="dropdown_item" href="#">捷運一日遊</a>
                  </div>
                  <div>
                    <a class="dropdown_item" href="#">開車一日遊</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 推薦景點 -->
    <div class="tab-pane fade" id="recommend" role="tabpanel" aria-labelledby="recommend-tab">
      <div style="display: flex; justify-content: center; margin-top: 5px;">
        <form class="d-flex" role="search" style="width:80%">
          <input class="form-control me-2"type="search"placeholder="查詢景點"aria-label="Search">
          <button class="btn btn-outline-success" type="submit">Search</button>
        </form>
      </div>
      <form action="" style="margin: 20px;color: black;" class="form_rec">
        <select name="s_day" id="s_day" style="font-size: 18px;">
          <option value="1">
            第一天
          </option>
          <option value="2">
            第二天
          </option>
        </select>
        <div style="font-size: 20px; margin: 5px auto;">
          <span><strong>是否推薦相似景點</strong></span>
          <input type="radio" id="yes" value="是" name="yn" style="margin-left: 5px;">
          <strong>是</strong>
          <input type="radio" id="no" value="否" name="yn" style="margin-left: 5px;">
          <strong>否</strong>
          <input type="submit" value="儲存" style="border-radius: 10px; margin-left: 5px">
        </div>
        <div class="dialog" id="dialog">
          <form action="#">
            <span>是否需要推薦相似景點</span>
            <br>
            <label class="yn" for="yes">
              是
            </label>
            <input type="radio" id="yes" value="是" name="yn">
            <label class="yn" for="no">
              否
            </label>
            <input type="radio" id="no" value="否" name="yn">
            <br>
            <input type="submit" value="確定">
          </form>
        </div>
      </form>
      <div id="button">
        <button class="filter_btn" value="all">台北市</button>
        <button class="filter_btn" value="zhongzheng">中正區</button>
        <button class="filter_btn" value="shilin">士林區</button>
        <button class="filter_btn" value="neihu">內湖區</button>
        <button class="filter_btn" value="zhongshan">中山區</button>
        <button class="filter_btn" value="datong">大同區</button>
        <button class="filter_btn" value="songshan">松山區</button>
        <button class="filter_btn" value="wanhua">萬華區</button>
        <button class="filter_btn" value="beitou">北投區</button>
        <button class="filter_btn" value="daan">大安區</button>
        <button class="filter_btn" value="shingyi">信義區</button>
        <button class="filter_btn" value="nangan">南港區</button>
        <button class="filter_btn" value="wenshan">文山區</button>
      </div>
      <div class="filter row">
        <form action="">
          {% csrf_token %}
          <div class="shingyi col-md-6" name="AttractionsContainer" id="AttractionsContainer">
            <!--我在JS QQ-->
          </div>
          <a href="#tab_r" class="tab_a"  id="clickLikeAttractions">
            <button value="提交">提交</button>
          </a>
        </form>
        {% comment %} 
        <div class="beitou col-md-6">
          <div class="col-5">
            <img src="/static/images/beitou.jpeg" alt=""  height="250">
          </div>
          <div class="col-7">
            <div style="text-align: left;">
              <p>景點名稱</p>
              <p>地址</p>
            </div>
          </div>
        </div>
        <div class="datong col-md-6">
          <div class="col-5">
            <img src="/static/images/Datong.jpeg" alt=""  height="250">
          </div>
          <div class="col-7">
            <div style="text-align: left;">
              <p>景點名稱</p>
              <p>地址</p>
            </div>
          </div>
        </div>
        <div class="shilin"><img src="/static/images/Shilin.jpeg" alt=""  height="250"></div>
        <div class="zhongshan"><img src="/static/images/Zhongshan.jpeg" alt=""  height="250"></div> {% endcomment %}
      </div>
      <div class="row">
        <form action="">
          {% csrf_token %}
          <div class="shingyi col-md-6" name="AttractionsContainer" id="AttractionsContainer_o"><!--我在JS QQ--></div>
          <a href="#tab_c" class="tab_a"  id="clickLikeAttractions_o">
            <button value="提交">提交1</button>
          </a>
        </form>
      </div>
    </div>
  </div>
</main>
{% endblock body %}
{% block content_script %}
  <script src="/static/js/create.js"></script>
  <script>

    window.addEventListener = function() {
      geoFindMe();
    };

    function geoFindMe() {
      const userLocation = document.getElementById("userLocation");
      function success(position) {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;
          userLocation.value = latitude+','+longitude;
          console.log(userLocation.value);
      }
  
      function error() {
        userLocation.textContent = "Unable to retrieve your location";
      }
  
      if (!navigator.geolocation) {
        userLocation.textContent = "Geolocation is not supported by your browser";
      } else {
        userLocation.textContent = "Locating…";
          navigator.geolocation.getCurrentPosition(success, error);
      }
    }
    var nowday = 1
    var nowDayValues = document.getElementById('nowday');
    nowDayValues.value = nowday;
    function clickDay(day){
      nowday=day
      nowDayValues.value = nowday;
    }

    //第1步驟 推薦附近景點~~~~
    var clickRecommend = document.getElementById('recommend-tab');
    clickRecommend.addEventListener("click",function(e){
      var nowtime=document.getElementById("nowtime");
      //var ct_status = 0;
      const userLocation = document.getElementById("userLocation");
        $.ajax({
          type: "POST",
          url: "/create/{{ct_id}}", // 替换为您的 views.py 文件的 URL
          data: {
              location: userLocation.value,
              nowtime: nowtime.value,
              ct_status : 0,
              csrfmiddlewaretoken: '{{ csrf_token }}',
          },
          success: function(response) {
            // 在這裡處理伺服器回傳的 JSON 數據
            console.log(response);  // 查看回傳的值

            // 進一步處理回傳的值，例如顯示在頁面上
            var m_list = response.m_list;  // 假設 m_list 是 JSON 中的一個鍵
            var crow_opening_list = response.crow_opening_list;  // 假設 crow_opening_list 是 JSON 中的一個鍵
            var mListContainer = document.getElementById("AttractionsContainer")
            for (var item of m_list) {
              mListContainer.innerHTML += '<input type="checkbox" value="'+item.place_id+'">';
              mListContainer.innerHTML +='<div class="col-5"><img src="/static/images/attractions/'+ item.place_id +'_0.jpg" alt=""  height="250"></div>';
              mListContainer.innerHTML +='<div class="col-7"><div style="text-align: left;">';
              mListContainer.innerHTML += "<p>" + item.a_name + "<p>";
              mListContainer.innerHTML += "<p>" + item.address + "<p></div></div>";

            }

          },
          error: function() {
          }
        });
    });

    var all_select=[];
    //第2步驟 推薦相似景點~~~
    var clickLikeAttractions = document.getElementById('clickLikeAttractions');
    clickLikeAttractions.addEventListener("click",function(e){
      var select_aid = document.getElementById('AttractionsContainer');
      var selectedCheckboxes = select_aid.querySelectorAll('input[type="checkbox"]:checked');
      var select_aid_list = [];
      var nowtime=document.getElementById("nowtime");
      selectedCheckboxes.forEach(function(checkbox) {
        select_aid_list.push(checkbox.value);
        all_select.push(checkbox.value)
      });
      console.log('选中的复选框值:', select_aid_list);
      console.log('目前所選的所有值',all_select)
      
      $.ajax({
        type: "POST",
        url: "/create/{{ct_id}}", // 替换为您的 views.py 文件的 URL
        data: {
            select_aid_list: select_aid_list,
            nowtime:nowtime.value,
            ct_status : 1,
            csrfmiddlewaretoken: '{{ csrf_token }}',
        },
        success: function(response) {
          // 在這裡處理伺服器回傳的 JSON 數據
          console.log(response);  // 查看回傳的值

          // 進一步處理回傳的值，例如顯示在頁面上
          var o_list = response.o_list;  // 假設 m_list 是 JSON 中的一個鍵
          var o_crow_opening_list = response.o_crow_opening_list;  // 假設 crow_opening_list 是 JSON 中的一個鍵
          var mListContainer = document.getElementById("AttractionsContainer_o")
          for (var item of o_list) {
            mListContainer.innerHTML += '<input type="checkbox" value="'+item.place_id+'">';
            mListContainer.innerHTML +='<div class="col-5"><img src="/static/images/attractions/'+ item.place_id +'_0.jpg" alt=""  height="250"></div>'
            mListContainer.innerHTML +='<div class="col-7"><div style="text-align: left;">'
            //mListContainer.innerHTML += "<p>" + item.place_id + "<p>";
            mListContainer.innerHTML += "<p>" + item.a_name + "<p>";
            mListContainer.innerHTML += "<p>" + item.address + "<p></div></div>";

          }

        },

        error: function() {
          alert('有錯誤!!!!!!!!!!!!!!!!!!!!!!!!!!!!');
        },
      });
    });

    //我是第3步驟   排序~~~
    var clickLikeAttractions_o = document.getElementById('clickLikeAttractions_o');
    clickLikeAttractions_o.addEventListener("click",function(e){
      var o_select_aid = document.getElementById('AttractionsContainer_o');
      var o_selectedCheckboxes = o_select_aid.querySelectorAll('input[type="checkbox"]:checked');
      var o_select_aid_list = [];
      var nowtime=document.getElementById("nowtime");
      o_selectedCheckboxes.forEach(function(checkbox) {
        o_select_aid_list.push(checkbox.value);
        all_select.push(checkbox.value)
      });
      console.log('选中的复选框值(相似):', o_select_aid_list);
      console.log('目前所選的所有值',all_select)
      
      $.ajax({
        type: "POST",
        url: "/create/{{ct_id}}", // 替换为您的 views.py 文件的 URL
        data: {
            all_select: all_select,
            nowtime:nowtime.value,
            ct_status : 2,
            csrfmiddlewaretoken: '{{ csrf_token }}',
        },
        success: function(response) {
          // 在這裡處理伺服器回傳的 JSON 數據
          console.log(response);  // 查看回傳的值
          // 進一步處理回傳的值，例如顯示在頁面上
          var final_result_list = response.final_result_list;  // 假設 m_list 是 JSON 中的一個鍵
          var final_crow_opening_list = response.final_crow_opening_list;  // 假設 crow_opening_list 是 JSON 中的一個鍵
          var final_remainder_result_list = response.final_remainder_result_list;  // 假設 m_list 是 JSON 中的一個鍵
          var final_remainder_crow_opening_list = response.final_remainder_crow_opening_list;  // 假設 crow_opening_list 是 JSON 中的一個鍵
          
          //安排完的景點
          var OrderAttractions = document.getElementById("OrderAttractions")
          var count=0
          var length_f=final_result_list.length;
          var all_a=[]
          for (let i = 0; i < length_f; i++) {
            final_result = final_result_list[i];
            final_crow_opening = final_crow_opening_list[i];
            console.log('final_result',final_result);
            console.log('final_crow_opening',final_crow_opening);
            count++;
            all_a.push(final_result.id)
            var temp='<div class="spot" id="spot' + count + '">';
            temp += final_result.a_name;
            temp += '<p>位在台北市XX區';
            temp += '<p>目前人潮流量：<br>';
            temp += '<p>營業時間：' + final_crow_opening.opening + '<br>';
            temp += '<p>建議停留時間：' + final_result.stay_time + '<br>';
            temp += '</div>';
        
            OrderAttractions.innerHTML += temp;
          }
          OrderAttractions.innerHTML += '<div id="hiddenId" style="display: none;">'+ all_a +'</div>';
          //剩餘的部分(註解掉的)
          var RemainderAttractions = document.getElementById("RemainderAttractions")
          var count_remainder=0
          var length_fr=final_remainder_result_list.length;
          
          if(length_fr!=0){
            RemainderAttractions.innerHTML +='<hr>剩餘的部分';
            for (let r = 0; r < length_fr; r++) {
              final_remainder_result = final_remainder_result_list[r];
              final_remainder_crow_opening = final_remainder_crow_opening_list[r];
              console.log('final_remainder_result',final_remainder_result);
              console.log('final_remainder_crow_opening',final_remainder_crow_opening);
              count++;
              var temp_r='<div class="spot" id="spot' + count + '">';
              temp_r += final_remainder_result.a_name;
              temp_r += '<div id="hiddenId" style="display: none;">'+ final_remainder_result.id +'</div>';;
              temp_r += '<p>位在台北市XX區';
              temp_r += '<p>目前人潮流量：<br>';
              temp_r += '<p>營業時間：' + final_remainder_crow_opening.opening + '<br>';
              temp_r += '<p>建議停留時間：' + final_remainder_result.stay_time + '<br>';
              temp_r += '</div>';

              RemainderAttractions.innerHTML += temp_r;
            }
          }

        },

        error: function() {
          alert('有錯誤!!!!!!!!!!!!!!!!!!!!!!!!!!!!');
        },
      });
    });


    {% comment %} var addDay = document.getElementById('addDay');
    var num = 1;
    addDay.addEventListener("click",function(e){
      var addDaydiv = document.getElementById("addDaydiv");
      addDaydiv.innerHTML += '<a href="/create/{{ct_id}}/'+num+'" class="tab_day" >'+num+' Day<br></a>'
      num ++;
    });
    
    addDay.click() //初始加 {% endcomment %}

    var saveDays = document.getElementById('saveDays');
    saveDays.addEventListener("click",function(e){
      alert('儲存'+'{{choiceday}}');
      var nowtime=document.getElementById("nowtime");
      var userLocation = document.getElementById("userLocation");
      var all_id = document.getElementById("hiddenId");
      if(all_id){
        all_id=all_id.textContent;
      }else{
        all_id='';
      }
      alert(all_id)
      console.log(nowtime,userLocation,all_id);
      $.ajax({
        type: "POST",
        url: "/create/{{ct_id}}", // 替换为您的 views.py 文件的 URL
        data: {
            days: '{{choiceday}}',
            location:userLocation.value,
            nowtime:nowtime.value,
            all_id:all_id,
            csrfmiddlewaretoken: '{{ csrf_token }}',
            ct_status:3,
        },
        success: function(response) {
          // 在這裡處理伺服器回傳的 JSON 數據
          console.log(response);  // 查看回傳的值  
          alert('儲存成功');
        },

        error: function() {
          alert('有錯誤!!!!!!!!!!!!!!!!!!!!!!!!!!!!');
        },
      });
    });

  </script>
{% endblock %}
</html>
